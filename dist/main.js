!function(t){var e={};function s(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,n){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(n,r,function(e){return t[e]}.bind(null,r));return n},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const n=[2,81],r=[2,83,1],i=[2,83,2],a=[2,83,3],o=[2,80,2],l=[2,80,3],h=[2,80,4],u=[2,82,0],d=[3];let p,g,c;var m=class{constructor(){this._isRunning=!1,this.lastMessage=null,this.status="Undefined",this.messageQueue=[],this.states={}}convertArray(t){let e=[];for(let s=0;s<t.length;s++)t[s]&&e.push("0x"+("00"+t[s].toString(16)).slice(-2));return e.join(" ")}convertDataView(t){let e=[];for(let s=0;s<t.byteLength;s++)e.push("0x"+("00"+t.getUint8(s).toString(16)).slice(-2));return e.join(" ")}mergeTypedArraysUnsafe(t,e,s){var n=new t.constructor(t.length+e.length+s.length);return n.set(t),n.set(e,t.length),n.set(s,t.length+e.length),n}on(t,e){"starting"===t?this.onStarting=e:"stopped"===t?this.onStopped=e:"running"===t?this.onRunning=e:console.log("invalid eventType, only","starting","running","stopped","are allowed")}handleNotifications(t){let e=t.target.value,s=this.states.status;this.states.value=e;let r=e.byteLength;if(this.lastMessage&&r>0&&2===e.getUint8(0)&&3===e.getUint8(r-1)){if(this.isCommandResult(this.lastMessage,e)){if(console.log("valid response"),this.lastMessage===o){e.getUint8(3),e.getUint8(4),e.getUint8(5)}else this.lastMessage===l||this.lastMessage===h||this.lastMessage===n&&(5===r&&0===e.getUint8(2)&&81===e.getUint8(3)?(this._isRunning=!1,this.states.status="Stopped",this.states.currentSpeed=0,this.states.currentIncline=0,this.onStopped&&s!==this.states.status&&this.onStopped(this.states)):r>5&&r<17?(this.states.status="Starting",this.states.currentSpeed=0,this.states.currentIncline=0,this.onStarting&&s!==this.states.status&&this.onStarting(this.states)):17===r&&(this.states.status="Running",this._isRunning=!0,this.states.currentSpeed=e.getUint8(3)/10,this.states.currentIncline=e.getUint8(4),this.onRunning&&this.onRunning(this.states)));this.lastMessage=null}else console.log("invalid response")}else console.log("invalid response")}checksum(t){var e,s=t.length,n=1;for(e=0;n<s;++n)e^=t[n];return new Uint8Array([e])}intervalHandler(){this.lastMessage?this.sendMessage(this.lastMessage):this.messageQueue.length>0?this.lastMessage=this.messageQueue.shift():this.addMessage(n);let t=[];this.messageQueue.forEach(e=>t.push(this.convertArray(e)))}sendMessage(t){let e=new Uint8Array(t),s=new Uint8Array(d),n=this.mergeTypedArraysUnsafe(e,this.checksum(e),s);return c.writeValue(n)}isCommandResult(t,e){for(var s=!0,n=e.byteLength,r=0;r<t.length&&s;r++)s=!(r>=n)&&(s&&t[r]===e.getUint8(r));return s}sendIncAndSpeed(t,e){if(this.isRunning()){let s=-1===e?this.states.currentSpeed:e,n=-1===t?this.states.currentIncline:t,r=this.mergeTypedArraysUnsafe(new Uint8Array(i),new Uint8Array([10*s]),new Uint8Array([n]));this.addMessage(r)}}isRunning(){return this._isRunning}addMessage(t){this.messageQueue.push(t)}initBTConnection(t){let e=this;navigator.bluetooth.requestDevice({filters:[{namePrefix:"FS-"},{services:["0000fff0-0000-1000-8000-00805f9b34fb"]}]}).then(t=>t.gatt.connect()).then(t=>t.getPrimaryService("0000fff0-0000-1000-8000-00805f9b34fb")).then(t=>(p=t,p.getCharacteristic("0000fff1-0000-1000-8000-00805f9b34fb"))).then(t=>(g=t,g.startNotifications().then(t=>(console.log("> Notifications started for c_serialPortRead"),g.addEventListener("characteristicvaluechanged",t=>{e.handleNotifications(t)}),g.addEventListener("characteristicvalueread",t=>{e.handleNotifications(t)}),p.getCharacteristic("0000fff2-0000-1000-8000-00805f9b34fb"))))).then(s=>{c=s,e.addMessage(o),e.addMessage(l),e.addMessage(h),setInterval(()=>{e.intervalHandler()},200),t&&t()}).catch(t=>{console.log(t)})}};var f=class{constructor(t,e,s){this.device=t,this.selectedProgram=e,this.chartContext=s,this.reinitProgram();let n=this;setInterval(()=>{n.updateProgress()},1e3)}setSelectedProgram(t){this.selectedProgram=t,this.reinitProgram()}initChart(){let t=[],e=[],s=[];this.programQueue.forEach((n,r)=>{t.push(""+r),e.push(n[0]),s.push(n[1])}),this.chart&&this.chart.destroy(),this.chart=new Chart(this.chartContext,{type:"line",data:{labels:t,datasets:[{label:"Incline",data:s,borderColor:"rgb(0, 255, 0)",steppedLine:"before",type:"line"},{label:"Speed",backgroundColor:"rgb(255, 99, 132)",borderColor:"rgb(255, 99, 132)",data:e,steppedLine:"before"}]},options:{}})}updateProgress(){if(this.device.isRunning()&&this.isExecuting()){let t=Math.round((Date.now()-this.programStartTime)/1e3),e=Math.round(100*t/this.programDuration),s=moment.duration(this.programDuration-t,"seconds").format("H:mm:ss");$("#programProgress").css("width",e+"%").attr("aria-valuenow",e).html(s);let n=(Date.now()-this.currentStepStartTime)/1e3,r=Math.round(100*n/this.currentStepDuration),i=Math.round(this.currentStepDuration-n);$("#stepProgress").css("width",r+"%").attr("aria-valuenow",r).html(i)}else $("#programProgress").css("width","0%").attr("aria-valuenow",0),$("#stepProgress").css("width","0%").attr("aria-valuenow",0)}isExecuting(){return this.programInterval&&!0}start(){let t=this;this.execute(),this.programInterval=setInterval(()=>{t.execute()},1e3*this.selectedProgram.stepDuration)}stop(){this.device.addMessage(a),clearInterval(this.programInterval),this.programInterval=null}setOnStepChangedListener(t){this.onStepChanged=t}getSteps(){return JSON.parse(JSON.stringify(this.programQueue))}execute(){this.device.isRunning()&&this.programQueue.length>0?(this.updateChart(),this.currentStep=this.programQueue.shift(),this.currentStepDuration=3===this.currentStep.length?this.currentStep[2]:this.selectedProgram.stepDuration,this.currentStepStartTime=Date.now(),this.device.sendIncAndSpeed(this.currentStep[1],this.currentStep[0]),this.onStepChanged&&this.onStepChanged()):this.stop()}updateChart(){console.log("Update Chart");let t=this.chart,e=t.data.datasets[1].data,s=t.data.datasets[0].data;this.programQueue.forEach((t,n)=>{e[n]=t[0],s[n]=t[1]});for(var n=this.programQueue.length;n<e.length;n++)e[n]=0,s[n]=0;t.update({duration:0})}reinitProgram(){this.programQueue=[],this.programStartTime=Date.now(),this.programDuration=this.selectedProgram.stepDuration*this.selectedProgram.steps.length,this.currentSpeed=0,this.currentIncline=0,this.currentStepDuration=0,this.currentStepStartTime=0,this.currentStep=0;let t=this.programQueue;this.selectedProgram.steps.forEach(e=>t.push(e)),this.initChart()}};const S={title:"Chaotic Hills",stepDuration:120,steps:[[2,0],[4,0],[6,0],[8,0],[4,0],[6,0],[8,0],[10,0],[4,0],[6,0],[8,0],[4,0],[6,0],[8,0],[10,0],[4,0],[2,0]]};let v=new m,b=document.getElementById("myChart").getContext("2d");Chart.defaults.global.animation.duration=0;var y=S,M=[S,{title:"Easy pizzy",stepDuration:120,steps:[[2,6],[4,4],[6,2],[4,4],[2,6],[4,4],[6,2],[4,4],[2,6],[4,4],[6,2],[4,4],[2,6],[4,4],[6,2],[4,4],[2,6]]}],C=new f(v,y,b);var P=class{constructor(){let t=this;this.initTopNav(),this.initDefaultIncline(),this.initDefaultSpeed(),this.initProgramList(),v.on("running",e=>{t.onRunning(e)}),v.on("stopped",e=>{t.onStopped(e)}),C.setOnStepChangedListener(()=>{t.onStepChanged()})}onRunning(t){let e=t.value;$("#status").html("Running"),$("#start").prop("disabled",!0),$("#stop").prop("disabled",!1),$("#program").prop("disabled",!1),$("#btnGroupDrop1").prop("disabled",!0),$("#speed").html(t.currentSpeed),$("#incline").html(t.currentIncline),$("#totalTime").html(moment.duration(e.getUint8(5)+256*e.getUint8(6),"seconds").format("H:mm:ss")),$("#totalDistance").html(e.getUint8(7)+256*e.getUint8(8)),$("#totalCalories").html((e.getUint8(9)+256*e.getUint8(10))/10)}onStopped(t){$("#status").html("Stopped"),$("#start").prop("disabled",!1),$("#stop").prop("disabled",!0),$("#program").prop("disabled",!0),$("#btnGroupDrop1").prop("disabled",!1),$("#speed").html(0),$("#incline").html(0),$("#totalTime").html("N/A"),$("#totalDistance").html("N/A"),$("#totalCalories").html("N/A"),C.reinitProgram()}onStepChanged(){var t=[];C.getSteps().forEach(e=>t.push("Speed:"+e[0]+"Incline:"+e[1])),$("#nextSteps").html(t.join("<br>"))}onSelectProgram(t){let e=$(t.target).data("program-index");y=M[e],$("#btnGroupDrop1").html(y.title),C.stop(),C.setSelectedProgram(y)}initProgramList(){let t=this;$("#btnGroupDrop1").html(y.title);let e=$("#programList");M.forEach((s,n)=>{let r=$('<a class="dropdown-item" href="#"></a>');r.text(s.title),r.data("program-index",n),r.on("click",e=>{t.onSelectProgram(e)}),e.append(r)})}initDefaultIncline(){for(var t=document.getElementsByClassName("default-incline"),e=0;e<t.length;e++){t[e].addEventListener("pointerup",(function(t){var e=parseInt(t.target.innerHTML);console.log("Set Incline",e),v.sendIncAndSpeed(e,-1)}))}}initDefaultSpeed(){for(var t=document.getElementsByClassName("default-speed"),e=0;e<t.length;e++){t[e].addEventListener("pointerup",(function(t){var e=parseInt(t.target.innerHTML);console.log("Set Speed",e),v.sendIncAndSpeed(-1,e)}))}}initTopNav(){$("#connect").on("pointerup",(function(t){v.initBTConnection(()=>{$("#start").prop("disabled",!1),$("#info").prop("disabled",!1)})})),$("#program").on("pointerup",(function(t){console.log("Start Program"),!C.isExecuting()&&v.isRunning()&&C.start()})),$("#start").on("pointerup",(function(t){console.log("Send start"),v.addMessage(r)})),$("#stop").on("pointerup",(function(t){console.log("Send stop"),v.addMessage(a),v.addMessage(u)}))}};$(document).ready(()=>{new P})}]);